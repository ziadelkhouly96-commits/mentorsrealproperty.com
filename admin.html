<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Ziad ElKhouly" />
    <meta name="copyright" content="-@copyright directed by Ziad ElKhouly-" />
    <title>MENTORS | Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Nunito:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --blue-900: #0b2c67;
        --blue-800: #123a7a;
        --blue-700: #1c4ea3;
        --blue-600: #1f63c9;
        --blue-500: #2b79e0;
        --blue-100: #e8f0ff;
        --white: #ffffff;
        --ink: #1b2430;
        --line: #d8e0ef;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: 'Nunito', system-ui, sans-serif;
        color: var(--ink);
        background: #f2f5fb;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      header {
        background: linear-gradient(180deg, var(--blue-900), var(--blue-700));
        color: white;
        padding: 24px 8vw 20px;
      }
      header h1 {
        margin: 0;
        font-family: 'Montserrat', sans-serif;
        text-transform: uppercase;
      }
      main {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 28px;
        padding: 24px 8vw 60px;
      }
      .panel {
        background: white;
        border-radius: 18px;
        padding: 22px;
        box-shadow: 0 18px 40px rgba(14, 38, 77, 0.08);
        border: 1px solid #e1e8f6;
      }
      .panel h2 {
        margin-top: 0;
        font-family: 'Montserrat', sans-serif;
        color: var(--blue-900);
      }
      label {
        display: block;
        font-weight: 600;
        margin: 12px 0 6px;
        color: #475569;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 11px 12px;
        border-radius: 10px;
        border: 1px solid var(--line);
        font-size: 14px;
        background: white;
      }
      textarea {
        min-height: 90px;
        resize: vertical;
      }
      button {
        margin-top: 16px;
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: none;
        background: var(--blue-600);
        color: white;
        font-weight: 700;
        font-size: 15px;
        cursor: pointer;
      }
      button:hover {
        background: var(--blue-700);
      }
      .list {
        display: grid;
        gap: 12px;
      }
      .item {
        padding: 14px;
        border-radius: 12px;
        border: 1px solid #d6dde8;
        background: white;
      }
      .item strong {
        display: block;
        color: var(--blue-900);
      }
      .item small {
        color: #64748b;
      }
      .danger {
        background: #b91c1c;
      }
      .danger:hover {
        background: #7f1d1d;
      }
      .message {
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 13px;
      }
      .error {
        background: #ffe6e6;
        color: #b42318;
      }
      .success {
        background: #e7f7ef;
        color: #15803d;
      }
      .tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }
      .tab-btn {
        background: #e8f0ff;
        border: 1px solid #c7d7f8;
        color: #0b2c67;
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
      }
      .tab-btn.active {
        background: #1f63c9;
        color: white;
        border-color: #1f63c9;
      }

      .login-box {
        max-width: 420px;
        margin: 30px auto 0;
        background: white;
        border-radius: 16px;
        padding: 22px;
        border: 1px solid #e1e8f6;
        box-shadow: 0 18px 40px rgba(14, 38, 77, 0.08);
      }
      .site-footer {
        display: flex;
        justify-content: center;
        background: #f2f5fb;
        padding: 8px 12px 16px;
      }
      .signature-card {
        width: min(420px, 92vw);
        background: transparent;
        border: none;
        border-radius: 0;
        padding: 4px 12px 6px;
        box-shadow: none;
        text-align: center;
      }
      .signature-meta {
        display: block;
        color: #64748b;
        font-size: 11px;
        letter-spacing: 0.08em;
        text-transform: none;
        font-family: 'Montserrat', sans-serif;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>MENTORS Admin Dashboard</h1>
    </header>

    <section id="admin-login" class="login-box">
      <h2 style="margin-top: 0; color: #0b2c67; font-family: Montserrat, sans-serif;">
        Admin Login
      </h2>
      <label for="admin-password">Password</label>
      <input id="admin-password" type="password" placeholder="Enter admin password" />
      <button id="admin-login-btn">Login</button>
      <div id="admin-login-message" class="message" style="display: none"></div>
    </section>

    <main id="admin-app" style="display: none">
      <section class="panel">
        <h2>Registered Users</h2>
        <div id="users" class="list"></div>
      </section>

      <section class="panel">
        <h2>Leads</h2>
        <div id="leads" class="list"></div>
      </section>

      <section class="panel">
        <h2>Manage Availability</h2>
        <label for="avail-destination">Destination</label>
        <select id="avail-destination">
          <option value="East Cairo">East Cairo</option>
          <option value="West Cairo">West Cairo</option>
          <option value="New Capital">New Capital</option>
          <option value="North Coast">North Coast</option>
          <option value="Gouna">Gouna</option>
          <option value="Ain Sokhna">Ain Sokhna</option>
        </select>

        <label for="avail-property">Property Type</label>
        <select id="avail-property">
          <option value="Studio">Studio</option>
          <option value="One Bedroom">One Bedroom</option>
          <option value="Two Bedroom">Two Bedroom</option>
          <option value="Three Bedrooms">Three Bedrooms</option>
          <option value="Duplex">Duplex</option>
          <option value="S Villa">S Villa</option>
          <option value="I Villa">I Villa</option>
          <option value="Townhouse">Townhouse</option>
          <option value="Twin House">Twin House</option>
          <option value="Standalones">Standalones</option>
          <option value="One Story">One Story</option>
        </select>

        <label for="avail-developer">Developer</label>
        <select id="avail-developer"></select>

        <label for="avail-budget">Budget</label>
        <input id="avail-budget" type="text" placeholder="25,000,000" />

        <label for="avail-delivery">Delivery</label>
        <select id="avail-delivery">
          <option value="Ready to Move">Ready to Move</option>
          <option value="One Year">One Year</option>
          <option value="Two Years">Two Years</option>
          <option value="Three Years">Three Years</option>
          <option value="Four Years">Four Years</option>
        </select>

        <label for="avail-notes">Notes</label>
        <textarea id="avail-notes" placeholder="Example: limited launch, direct developer pricing"></textarea>

        <button id="add-availability">Add Availability</button>
        <div id="avail-message" class="message" style="display: none"></div>
      </section>

      <section class="panel">
        <h2>Manage Developers</h2>
        <label for="developer-name">Developer Name</label>
        <input id="developer-name" type="text" placeholder="Add new developer" />
        <button id="add-developer">Add Developer</button>
        <div id="developer-message" class="message" style="display: none"></div>
        <div id="developers" class="list" style="margin-top: 14px"></div>
      </section>

      <section class="panel">
        <h2>Current Availability</h2>
        <div class="tabs" id="availability-tabs"></div>
        <div id="availability" class="list"></div>
      </section>
    </main>
    <footer class="site-footer" role="contentinfo" aria-label="signature">
      <div class="signature-card">
        <span class="signature-meta">-@copyright directed by Ziad ElKhouly-</span>
      </div>
    </footer>

    <script>
      const adminLoginSection = document.getElementById('admin-login');
      const adminApp = document.getElementById('admin-app');
      const loginBtn = document.getElementById('admin-login-btn');
      const loginMsg = document.getElementById('admin-login-message');

      const usersContainer = document.getElementById('users');
      const leadsContainer = document.getElementById('leads');
      const availabilityContainer = document.getElementById('availability');
      const availMessage = document.getElementById('avail-message');
      const availBudget = document.getElementById('avail-budget');
      const developersContainer = document.getElementById('developers');
      const developerMessage = document.getElementById('developer-message');
      const availDeveloperSelect = document.getElementById('avail-developer');
      const availabilityButton = document.getElementById('add-availability');
      const availabilityTabs = document.getElementById('availability-tabs');
      let editingAvailabilityId = null;
      let availabilityItems = [];
      let developerList = [];
      let activeDeveloperTab = 'ALL';

      function showMessage(el, message, type) {
        el.textContent = message;
        el.className = `message ${type}`;
        el.style.display = 'block';
      }

      function setAuthed(authed) {
        adminLoginSection.style.display = authed ? 'none' : 'block';
        adminApp.style.display = authed ? 'grid' : 'none';
      }

      function getToken() {
        return sessionStorage.getItem('adminToken') || '';
      }
      function setToken(token) {
        sessionStorage.setItem('adminToken', token);
      }
      function clearToken() {
        sessionStorage.removeItem('adminToken');
      }

      async function authFetch(url, options = {}) {
        const headers = { ...(options.headers || {}) };
        headers['X-Admin-Token'] = getToken();
        if (options.body && !headers['Content-Type']) {
          headers['Content-Type'] = 'application/json';
        }
        const response = await fetch(url, { ...options, headers });
        if (response.status === 401) {
          clearToken();
          setAuthed(false);
        }
        return response;
      }

      function formatBudget(value) {
        const numeric = value.replace(/,/g, '').replace(/\D/g, '');
        if (!numeric) return '';
        return Number(numeric).toLocaleString('en-US');
      }
      availBudget.addEventListener('input', () => {
        availBudget.value = formatBudget(availBudget.value);
      });

      async function loadUsers() {
        usersContainer.innerHTML = '';
        const response = await authFetch('/api/users');
        if (!response.ok) return;
        const data = await response.json();
        if (!data.users.length) {
          usersContainer.innerHTML = '<div class="item">No users yet.</div>';
          return;
        }
        data.users.forEach((user) => {
          const item = document.createElement('div');
          item.className = 'item';
          item.innerHTML = `
            <strong>${user.username} · ${user.phone}</strong>
            <small>${user.email}</small>
            <div>Password: ${user.password}</div>
            <small>Created: ${new Date(user.createdAt).toLocaleString()}</small>
          `;
          const removeBtn = document.createElement('button');
          removeBtn.className = 'danger';
          removeBtn.textContent = 'Remove User';
          removeBtn.addEventListener('click', async () => {
            await authFetch(`/api/users/${user.id}`, { method: 'DELETE' });
            loadUsers();
          });
          item.appendChild(removeBtn);
          usersContainer.appendChild(item);
        });
      }

      async function loadLeads() {
        leadsContainer.innerHTML = '';
        const response = await authFetch('/api/leads');
        if (!response.ok) return;
        const data = await response.json();
        if (!data.leads.length) {
          leadsContainer.innerHTML = '<div class="item">No leads yet.</div>';
          return;
        }
        data.leads.forEach((lead) => {
          const item = document.createElement('div');
          item.className = 'item';
          item.innerHTML = `
            <strong>${lead.username} · ${lead.phone}</strong>
            <small>${lead.email}</small>
            <div>Password: ${lead.password || 'Not provided'}</div>
            <div>Destination: ${lead.destination}</div>
            <div>Property: ${lead.propertyType}</div>
            <div>Developer: ${lead.developer || 'Not specified'}</div>
            <div>Budget: ${lead.budget}</div>
            <div>Delivery: ${lead.delivery}</div>
            <div>Looking for: ${lead.lookingFor}</div>
            <small>Created: ${new Date(lead.createdAt).toLocaleString()}</small>
          `;

          const removeBtn = document.createElement('button');
          removeBtn.className = 'danger';
          removeBtn.textContent = 'Remove Lead';
          removeBtn.addEventListener('click', async () => {
            await authFetch(`/api/leads/${lead.id}`, { method: 'DELETE' });
            loadLeads();
          });
          item.appendChild(removeBtn);

          leadsContainer.appendChild(item);
        });
      }

      function normalizeName(value) {
        return String(value || '').trim().toLowerCase();
      }

      function buildAvailabilityTabs(list) {
        availabilityTabs.innerHTML = '';
        const allBtn = document.createElement('button');
        allBtn.className = `tab-btn ${activeDeveloperTab === 'ALL' ? 'active' : ''}`;
        allBtn.textContent = 'All';
        allBtn.addEventListener('click', () => {
          activeDeveloperTab = 'ALL';
          renderAvailability();
        });
        availabilityTabs.appendChild(allBtn);

        list.forEach((dev) => {
          const btn = document.createElement('button');
          btn.className = `tab-btn ${
            normalizeName(activeDeveloperTab) === normalizeName(dev) ? 'active' : ''
          }`;
          btn.textContent = dev;
          btn.addEventListener('click', () => {
            activeDeveloperTab = dev;
            renderAvailability();
          });
          availabilityTabs.appendChild(btn);
        });
      }

      function renderAvailability() {
        availabilityContainer.innerHTML = '';
        let filtered = availabilityItems;
        if (activeDeveloperTab !== 'ALL') {
          filtered = availabilityItems.filter(
            (item) => normalizeName(item.developer) === normalizeName(activeDeveloperTab)
          );
        }
        if (!filtered.length) {
          availabilityContainer.innerHTML = '<div class="item">No availability added yet.</div>';
          return;
        }
        filtered.forEach((item) => {
          const card = document.createElement('div');
          card.className = 'item';
          card.innerHTML = `
            <strong>${item.destination} · ${item.propertyType}</strong>
            <div>Developer: ${item.developer || 'N/A'}</div>
            <div>Budget: ${item.budget}</div>
            <div>Delivery: ${item.delivery}</div>
            <div>${item.notes || ''}</div>
          `;

          const editBtn = document.createElement('button');
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', () => {
            editingAvailabilityId = item.id;
            document.getElementById('avail-destination').value = item.destination || '';
            document.getElementById('avail-property').value = item.propertyType || '';
            const devSelect = document.getElementById('avail-developer');
            const target = normalizeName(item.developer);
            let matched = false;
            Array.from(devSelect.options).forEach((opt) => {
              if (normalizeName(opt.value) === target) {
                devSelect.value = opt.value;
                matched = true;
              }
            });
            if (!matched && item.developer) {
              const tempOpt = document.createElement('option');
              tempOpt.value = item.developer;
              tempOpt.textContent = item.developer;
              devSelect.insertBefore(tempOpt, devSelect.firstChild);
              devSelect.value = item.developer;
            }
            document.getElementById('avail-budget').value = item.budget || '';
            document.getElementById('avail-delivery').value = item.delivery || '';
            document.getElementById('avail-notes').value = item.notes || '';
            availabilityButton.textContent = 'Save Changes';
            showMessage(availMessage, 'Editing availability. Update fields then save.', 'success');
          });

          const removeBtn = document.createElement('button');
          removeBtn.className = 'danger';
          removeBtn.textContent = 'Remove';
          removeBtn.addEventListener('click', async () => {
            await authFetch(`/api/availability/${item.id}`, { method: 'DELETE' });
            loadAvailability();
          });

          card.appendChild(editBtn);
          card.appendChild(removeBtn);
          availabilityContainer.appendChild(card);
        });
      }

      async function loadAvailability() {
        availabilityContainer.innerHTML = '';
        const response = await fetch('/api/availability');
        const data = await response.json();
        if (!response.ok || !data.items.length) {
          availabilityContainer.innerHTML = '<div class="item">No availability added yet.</div>';
          return;
        }
        availabilityItems = data.items;
        const list =
          developerList.length > 0
            ? developerList
            : Array.from(
                new Set(
                  availabilityItems
                    .map((item) => item.developer)
                    .filter((name) => Boolean(name))
                )
              );
        buildAvailabilityTabs(list);
        renderAvailability();
      }

      async function loadDevelopers() {
        developersContainer.innerHTML = '';
        availDeveloperSelect.innerHTML = '';
        const response = await fetch('/api/developers');
        const data = await response.json();

        if (!response.ok || !data.developers.length) {
          developersContainer.innerHTML = '<div class="item">No developers yet.</div>';
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No developers yet';
          availDeveloperSelect.appendChild(opt);
          return;
        }

        developerList = data.developers.map((dev) => dev.name);
        data.developers.forEach((dev) => {
          const option = document.createElement('option');
          option.value = dev.name;
          option.textContent = dev.name;
          availDeveloperSelect.appendChild(option);

          const item = document.createElement('div');
          item.className = 'item';
          item.innerHTML = `<strong>${dev.name}</strong>`;

          const removeBtn = document.createElement('button');
          removeBtn.className = 'danger';
          removeBtn.textContent = 'Remove';
          removeBtn.addEventListener('click', async () => {
            await authFetch(`/api/developers/${dev.id}`, { method: 'DELETE' });
            loadDevelopers();
          });

          item.appendChild(removeBtn);
          developersContainer.appendChild(item);
        });
      }

      availabilityButton.addEventListener('click', async () => {
        const destination = document.getElementById('avail-destination').value;
        const propertyType = document.getElementById('avail-property').value;
        const developer = document.getElementById('avail-developer').value;
        const budget = document.getElementById('avail-budget').value;
        const delivery = document.getElementById('avail-delivery').value;
        const notes = document.getElementById('avail-notes').value.trim();

        if (!developer) {
          showMessage(availMessage, 'Please select a developer.', 'error');
          return;
        }
        if (!budget) {
          showMessage(availMessage, 'Please enter a budget.', 'error');
          return;
        }

        const isEditing = Boolean(editingAvailabilityId);
        const response = await authFetch(
          isEditing ? `/api/availability/${editingAvailabilityId}` : '/api/availability',
          {
            method: isEditing ? 'PUT' : 'POST',
            body: JSON.stringify({ destination, propertyType, developer, budget, delivery, notes })
          }
        );

        let data = {};
        try {
          data = await response.json();
        } catch (err) {
          data = {};
        }
        if (!response.ok) {
          showMessage(availMessage, data.error || 'Request failed. Check server and try again.', 'error');
          return;
        }

        showMessage(
          availMessage,
          isEditing ? 'Availability updated.' : 'Availability added.',
          'success'
        );
        editingAvailabilityId = null;
        availabilityButton.textContent = 'Add Availability';
        document.getElementById('avail-notes').value = '';
        document.getElementById('avail-budget').value = '';
        loadAvailability();
      });

      document.getElementById('add-developer').addEventListener('click', async () => {
        const name = document.getElementById('developer-name').value.trim();
        if (!name) {
          showMessage(developerMessage, 'Please enter a developer name.', 'error');
          return;
        }
        const response = await authFetch('/api/developers', {
          method: 'POST',
          body: JSON.stringify({ name })
        });

        const data = await response.json();
        if (!response.ok) {
          showMessage(developerMessage, data.error || 'Unable to add developer.', 'error');
          return;
        }

        showMessage(developerMessage, 'Developer added.', 'success');
        document.getElementById('developer-name').value = '';
        loadDevelopers();
      });

      loginBtn.addEventListener('click', async () => {
        const password = document.getElementById('admin-password').value.trim();
        const response = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        const data = await response.json();
        if (!response.ok) {
          showMessage(loginMsg, data.error || 'Wrong password.', 'error');
          return;
        }
        setToken(password);
        setAuthed(true);
        loadUsers();
        loadLeads();
        loadAvailability();
        loadDevelopers();
      });

      if (getToken()) {
        setAuthed(true);
        loadUsers();
        loadLeads();
        loadDevelopers().then(loadAvailability);
      }
    </script>
  </body>
</html>
